{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="{{ url_for('admin.dashboard') }}" class="text-xl font-bold text-gray-800">‚Üê Back to Dashboard</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('admin.manage_schedules') }}" class="text-blue-600 hover:text-blue-800">Manage Schedules</a>
                    <a href="{{ url_for('admin.view_schedules') }}" class="text-blue-600 hover:text-blue-800">View All Schedules</a>
                    <form action="{{ url_for('auth.logout') }}" method="post" class="inline">
                        <button type="submit" class="text-red-600 hover:text-red-800">Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-semibold text-gray-900">Staff Management</h1>
                <button onclick="openAddStaffModal()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Add New Staff
                </button>
            </div>

            <!-- Staff List Table -->
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="staffTableBody">
                        {% for staff in staff %}
                        <tr data-staff-id="{{ staff.id }}">
                            <td class="px-6 py-4 whitespace-nowrap">{{ staff.username }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ staff.email }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">{{ staff.phone }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if staff.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ 'Active' if staff.is_active else 'Inactive' }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button onclick="openEditStaffModal({{ staff.id }})" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                <button onclick="toggleStaffStatus({{ staff.id }})" class="text-blue-600 hover:text-blue-900">
                                    {{ 'Deactivate' if staff.is_active else 'Activate' }}
                                </button>
                                <button onclick="deleteStaff({{ staff.id }})" class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Staff Modal -->
<div id="addStaffModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Add New Staff Member</h3>
            <form id="addStaffForm" class="mt-4">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="username">Username</label>
                    <input type="text" id="username" name="username" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="email">Email</label>
                    <input type="email" id="email" name="email" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="phone">Phone</label>
                    <input type="tel" id="phone" name="phone" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="password">Password</label>
                    <input type="password" id="password" name="password" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Add Staff
                    </button>
                    <button type="button" onclick="closeAddStaffModal()"
                        class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Staff Modal -->
<div id="editStaffModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Edit Staff Member</h3>
            <form id="editStaffForm" class="mt-4">
                <input type="hidden" id="editStaffId">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="editUsername">Username</label>
                    <input type="text" id="editUsername" name="username" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="editEmail">Email</label>
                    <input type="email" id="editEmail" name="email" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="editPhone">Phone</label>
                    <input type="tel" id="editPhone" name="phone" required
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="editPassword">New Password (optional)</label>
                    <input type="password" id="editPassword" name="password"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Save Changes
                    </button>
                    <button type="button" onclick="closeEditStaffModal()"
                        class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Add Staff Modal Functions
    function openAddStaffModal() {
        document.getElementById('addStaffModal').classList.remove('hidden');
    }

    function closeAddStaffModal() {
        document.getElementById('addStaffModal').classList.add('hidden');
        document.getElementById('addStaffForm').reset();
    }

    // Edit Staff Modal Functions
    function openEditStaffModal(staffId) {
        const row = document.querySelector(`tr[data-staff-id="${staffId}"]`);
        document.getElementById('editStaffId').value = staffId;
        document.getElementById('editUsername').value = row.cells[0].textContent;
        document.getElementById('editEmail').value = row.cells[1].textContent;
        document.getElementById('editPhone').value = row.cells[2].textContent;
        document.getElementById('editStaffModal').classList.remove('hidden');
    }

    function closeEditStaffModal() {
        document.getElementById('editStaffModal').classList.add('hidden');
        document.getElementById('editStaffForm').reset();
    }

    // Form Submission Handlers
    document.getElementById('addStaffForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = {
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            password: document.getElementById('password').value
        };

        try {
            const response = await fetch('{{ url_for("admin.add_staff") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            if (response.ok) {
                window.location.reload();
            } else {
                alert(data.error);
            }
        } catch (error) {
            alert('An error occurred while adding staff member');
        }
    });

    document.getElementById('editStaffForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const staffId = document.getElementById('editStaffId').value;
        const formData = {
            username: document.getElementById('editUsername').value,
            email: document.getElementById('editEmail').value,
            phone: document.getElementById('editPhone').value,
            password: document.getElementById('editPassword').value
        };

        if (!formData.password) delete formData.password;

        try {
            const response = await fetch(`{{ url_for("admin.update_staff", staff_id=0) }}`.replace('0', staffId), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            if (response.ok) {
                window.location.reload();
            } else {
                alert(data.error);
            }
        } catch (error) {
            alert('An error occurred while updating staff member');
        }
    });

    // Toggle Staff Status
    async function toggleStaffStatus(staffId) {
        const row = document.querySelector(`tr[data-staff-id="${staffId}"]`);
        const currentStatus = row.querySelector('span').textContent.trim() === 'Active';
        
        try {
            const response = await fetch(`{{ url_for("admin.update_staff", staff_id=0) }}`.replace('0', staffId), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    is_active: !currentStatus
                })
            });

            const data = await response.json();
            if (response.ok) {
                window.location.reload();
            } else {
                alert(data.error);
            }
        } catch (error) {
            alert('An error occurred while updating staff status');
        }
    }

    // Delete Staff
    async function deleteStaff(staffId) {
        if (!confirm('Are you sure you want to delete this staff member?')) return;

        try {
            const response = await fetch(`{{ url_for("admin.delete_staff", staff_id=0) }}`.replace('0', staffId), {
                method: 'DELETE'
            });

            const data = await response.json();
            if (response.ok) {
                window.location.reload();
            } else {
                alert(data.error);
            }
        } catch (error) {
            alert('An error occurred while deleting staff member');
        }
    }
</script>
{% endblock %}
